<template>
  <div class="api-doc" :id="api._id">
    <div class="fields">
      <div class="field name">
        <h2>
          <label :class="diffStyle('name')">{{api.name}}</label>
          <span class="method" :class="methodStyle">{{method}}</span>
        </h2>
        <div class="control" v-if="!isPreview && !diffMode">
          <el-button class="follow" @click="diff()">diff</el-button>
          <el-button class="follow"
                     icon="star-on"
                     v-if="followed"
                     type="primary"
                     @click="cancelfollow()">unfollow</el-button>
          <el-button class="follow"
                     icon="star-off"
                     v-else
                     @click="doFollow()">follow</el-button>
          <el-button type="primary" class="edit" icon="edit" @click="edit()">edit</el-button>
        </div>
      </div>
      <div class="field url">
        <div>
          <label><code>Mock</code>url：</label>
          <p class="prod code">{{url}}</p>
        </div>
        <div v-if="api.devUrl" :class="diffStyle('devUrl')">
          <label>Test url：</label>
          <p class="prod code">{{api.devUrl}}</p>
        </div>
        <div v-if="api.prodUrl" :class="diffStyle('prodUrl')">
          <label>Prod url：</label>
          <p class="prod code">{{api.prodUrl}}</p>
        </div>
      </div>
      <div class="field">
        <label>Params</label>
        <schema v-for="(schema, key) in schemaParams"
                v-if="hasParams(schema.params)"
                :diff-mode="diffMode"
                :diff-stack="diffStack"
                :diff-path="'options.params.' + key"
                :name="key"
                :schema="schema"
                :key="key"></schema>
      </div>
      <div class="field" v-if="headers.params.length">
        <label>Headers</label>
        <schema :schema="headers" name="headers"></schema>
      </div>
      <div class="field" v-if="api.options.response && api.options.response.length">
        <label>Response</label>
        <schemas :schemas="api.options.response"
                 name="response"
                 :diff-mode="diffMode"
                 :diff-stack="diffStack"
                 :diff-path="'options.response'"></schemas>
      </div>
      <div class="field mock-data" v-else>
        <label>Mock data</label>
        <mock-data :mock-data="api.dsl"></mock-data>
      </div>
      <div class="field desc" v-show="api.desc">
        <label>Desc</label>
        <div class="editor-style" v-html="api.desc" :class="diffStyle('desc')"></div>
      </div>
    </div>
  </div>
</template>

<script>
import ParamsTable from './ParamsTable'
import Schemas from './Schemas'
import Schema from './Schema'
import MockData from './MockData'
import CopyButton from '@/components/common/CopyButton'
import { mapActions, mapState } from 'vuex'
// 为了接口描述在文档中显示的跟编辑时样式一致而引入
import 'simditor/styles/simditor.css'
import { getDiffStyle } from '@/util/jsonDiff'
export default {
  components: {
    CopyButton,
    Schemas,
    Schema,
    ParamsTable,
    MockData
  },
  props: {
    diffStack: {
      type: Object,
      required: false
    },
    api: {
      type: Object,
      required: true
    }
  },
  methods: {
    ...mapActions([
      'follow',
      'unfollow'
    ]),
    diffStyle (path) {
      return getDiffStyle(this.diffStack, path)
    },
    diff () {
      this.$router.push(`/diff/${this.api.group}/${this.api._id}`)
    },
    edit () {
      this.$store.commit('UPDATE_API', this.api)
      this.$store.commit('CHANGE_MODE', 'edit')
      this.$router.push(`/edit/${this.api.group}/${this.api._id}`)
    },
    hasParams (params) {
      return params && params.filter(p => p.key).length > 0
    },
    doFollow () {
      this.follow(this.api._id).then(rs => {
        this.api.follower = rs.data.follower
      })
    },
    cancelfollow () {
      this.unfollow(this.api._id).then(rs => {
        this.api.follower = rs.data.follower
      })
    }
  },
  computed: {
    ...mapState(['user', 'diffMode']),
    followed () {
      return !!this.api.follower.find(f => f === this.user._id)
    },
    isPreview () {
      return !!this.$route.query.preview
    },
    url () {
      const mockUrl = `${this.$store.state.serverRoot}/client/${this.api._id}`
      const path = this.api.options.params.path
      if (path.length) {
        const pathUrl = path.filter(p => p.key).map(p => `/:${p.key}`).join('')
        return pathUrl ? `${mockUrl}${pathUrl}` : mockUrl
      } else {
        return mockUrl
      }
    },
    method () {
      return this.api.options.method.toUpperCase()
    },
    methodStyle () {
      return {
        ...this.diffStyle('options.method'),
        [this.method]: true
      }
    },
    schemaParams () {
      const schemas = {}
      for (const key in this.api.options.params) {
        // get方法没有body参数
        if (this.method === 'GET' && key === 'body') {
          continue
        }
        schemas[key] = {
          example: this.api.options.examples[key],
          params: this.api.options.params[key]
        }
      }
      return schemas
    },
    headers () {
      return this.api.options.headers
    }
  }
}
</script>
<style lang="less">
.diff {
  position: relative;

  &-delete {
    *, & {
      background-color: #ffeef0 !important;
      text-decoration: line-through;
    }
  }
  &-add {
    *, & {
      background-color: #e6ffed !important;
    }
  }
  &-update {
    *, & {
      background-color: #aefbc4 !important;
    }
  }
}

.apis-doc {
  width: 100%;
  height: 100%;
  overflow-x: hidden;
  overflow-y: auto;
}

.api-doc {
  width: 100%;
  padding: 30px;

  &~.api-doc {
    border-top: 1px solid #ddd;
  }

  h2 {
    border-bottom: 1px solid #ececec;
    font-weight: bold;
    padding: 10px 0;
  }
  .code {
    border: 1px solid #e6e6e6;
    padding: 6px 10px;
    border-radius: 3px;
    color: #666;
    background-color: #f8f8f8;
  }

  .fields {
    width: 100%;
    min-width: 650px;
  }

  .method {
    color: #3eb63e;
    font-weight: normal;
    margin-left: 10px;
  }

  .field {
    width: 100%;
    position: relative;
    margin-bottom: 30px;

    &.name .control {
      position: absolute;
      right: 0px;
      top: 0;
    }
    &:last-child {
      margin-bottom: 0;
    }
    &.url {
      &>div {
        padding-left: 75px;
        position: relative;
        margin-bottom: 10px;

        .code {
          word-break: break-all;
        }
      }
      label {
        position: absolute;
        left: 0;
        top: 10px;
      }
    }

    &>label {
      display: block;
      font-size: 16px;
      border-bottom: 1px solid #e6e6e6;
      line-height: 2;
      margin-bottom: 20px;
    }
  }
}
.method {
  &.put,
  &.PUT,
  &.PATCH,
  &.patch,
  &.post,
  &.POST {
    color: #f5a623;
  }
  &.get,
  &.GET {
    color: #3eb63e;
  }
}
</style>
